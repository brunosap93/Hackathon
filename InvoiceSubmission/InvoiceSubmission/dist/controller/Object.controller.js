sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","../model/formatter","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,r,i,a,o){"use strict";var s=0;var n=0;var c=100;return e.extend("ns.InvoiceSubmission.controller.Object",{formatter:i,onInit:function(){var e=new t({busy:true,delay:0,PO:false});this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.setModel(e,"objectView")},_loadPurchaseOrders:function(){var e=this;this._result=[];var t=this.getResourceBundle();var r=false;sap.ui.core.BusyIndicator.show(0);$.ajax({type:"GET",url:"/ProcurementService/browse/PurchaseOrder?$filter=Status eq 'Pending'&$expand=To_PurchaseOrderItems($orderby=PurchaseOrderItem asc;$filter=Status eq 'Pending')",cache:false,dataType:"json",async:false,error:function(i,a){sap.ui.core.BusyIndicator.hide();r=false;var o=t.getText("msnDataBaseError");e._addMessageManager(o)},success:function(t){sap.ui.core.BusyIndicator.hide();e._result=t;r=true}});var i=e._result;return i},onSubmitInvoice:function(){var e=this.getView().byId("switchPO").getState();var t=this;sap.ui.core.BusyIndicator.show(0);if(e){debugger;var r=JSON.stringify({RuleServiceId:"6a832a7ae8c440eab3ab698cca900350",Vocabulary:[{PoInvoiceDifference:{Percentage:c,Amount:0,BusinessPartnerName:this.getView().getBindingContext().getObject("SupplierName")}}]});$.ajax({type:"POST",url:"/BUSINESS_RULES/rules-service/rest/v2/workingset-rule-services",cache:false,dataType:"json",headers:{"Content-Type":"application/json"},data:r,async:false,error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("An error has occured. Status: "+t)},success:function(e){t.onAfterCheck(e.Result[0].CloseInvoice.Status)}})}else{var i=!!this.getView().$().closest(".sapUiSizeCompact").length;o.confirm("This invoice doesn't have a PO and it will go through an internal approval process, are you sure you want to continue?",{styleClass:i?"sapUiSizeCompact":"",onClose:function(e){if(e=="OK"){var r=t.byId("table").getBindingContext().sPath.split("'")[1];var i=JSON.stringify({definitionId:"approvalinvoicestory",context:{type:"nonpo",invoiceNumber:r}});t.triggerWorkflow(i);a.show("Invoice without PO sent for approval")}else{sap.ui.core.BusyIndicator.hide()}}})}},onAfterCheck:function(e){var t=this;if(e=="Error"){var r=!!this.getView().$().closest(".sapUiSizeCompact").length;sap.ui.core.BusyIndicator.hide();o.error("The net amount difference variance the selected invoice and the purchae order items is too high. ",{styleClass:r?"sapUiSizeCompact":""})}else if(e=="Approval"){var r=!!this.getView().$().closest(".sapUiSizeCompact").length;o.warning("The net amount difference variance the selected invoice and the purchae order items is above the allowed threshold and it will require to be approved by "+"our purchasing department, do you want to continue?",{actions:[o.Action.OK,o.Action.CANCEL],styleClass:r?"sapUiSizeCompact":"",onClose:function(e){if(e=="OK"){var r=t.byId("table").getBindingContext().sPath.split("'")[1];var i=t.byId("treeTable");var o=i.getSelectedIndices();var s=[];for(var n=0;n<o.length;n++){var c=i.getContextByIndex(o[n]);if(c!=undefined){var u=String(c.sPath);if(u.indexOf("To_PurchaseOrderItems")>0){s.push(String(c.getObject("PurchaseOrderItem")))}}}var d=JSON.stringify({definitionId:"approvalinvoicestory",context:{type:"po",invoiceNumber:r,PONumber:c.getObject("DocNumber_DocNumber"),POitems:s}});t.triggerWorkflow(d);a.show("Invoice without PO sent for approval")}else{sap.ui.core.BusyIndicator.hide()}}})}else if(e=="Approved"){o.warning("There is a variance between the invoce and the purchase order net amounts, "+"do you want to continue?",{actions:[o.Action.OK,o.Action.CANCEL],styleClass:r?"sapUiSizeCompact":"",onClose:function(e){if(e=="OK"){t.updateRecords("Done")}else{sap.ui.core.BusyIndicator.hide()}}})}else if(e=="Success"){o.confirm("This invoice will be received, are you sure you want to continue?",{styleClass:r?"sapUiSizeCompact":"",onClose:function(e){if(e=="OK")t.updateRecords("Done");else{sap.ui.core.BusyIndicator.hide()}}})}else{a.show("Something went wrong")}},updateRecords:function(e){var t=this.getView().byId("treeTable").getSelectedIndices();var r="";this.getView().byId("invoiceStatus").setText(e);for(var i=0;i<t.length;i++){r=this.getView().byId("treeTable").getContextByIndex(t[i]).getObject().ID;this.closeItems(r,e)}sap.ui.core.BusyIndicator.hide();this.onNavBack()},closeItems:function(e,t){var r=JSON.stringify({Status:t});$.ajax({type:"PATCH",url:"/ProcurementService/browse/PurchaseOrderItems("+e+")",cache:false,dataType:"json",headers:{"Content-Type":"application/json"},data:r,async:false,error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("An error has occured. Status: "+t)},success:function(e){sap.ui.core.BusyIndicator.hide()}})},triggerWorkflow:function(e){var t=this;$.ajax({type:"POST",url:"/workflowService/workflow-service/rest/v1/workflow-instances",cache:false,dataType:"json",headers:{"Content-Type":"application/json"},data:e,async:false,error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("An error has occured. Status: "+t)},success:function(e){t.updateRecords("Approving");a.show("Approval process has been initiated")}})},onSwitchChange:function(e){var t=this.getModel("objectView");t.setProperty("/PO",e.getParameter("state"))},oRowSelection:function(e){var t=e.getSource().getSelectedIndex();var r=e.getSource().getContextByIndex(e.getSource().getSelectedIndex());if(r!=undefined){var i=String(r.sPath);if(i.indexOf("To_PurchaseOrderItems")<0){var a=i.substring(7);var o=parseInt(a);var c=this.getView().byId("treeTable").getModel().getData().value[o].To_PurchaseOrderItems.length;this.getView().byId("treeTable").addSelectionInterval(t+1,t+c)}}var u=e.getSource().getSelectedIndices();var d;var l=0;for(var h=0;h<u.length;h++){var r=e.getSource().getContextByIndex(u[h]-1);if(r!=undefined){var i=String(r.sPath);var g=parseInt(i.split("/")[2]);var p=this.getView().byId("treeTable").getModel().getData().value[g].To_PurchaseOrderItems[u[h]-1];if(p!=undefined){d=p.NetPriceAmount;l+=d}}}s=n-l;this.updateNumber(s)},updateNumber:function(e){this.getView().byId("difAmount").setValue(e);if(e<0)this.getView().byId("difAmount").setIndicator("Up");else if(e>0)this.getView().byId("difAmount").setIndicator("Down");else this.getView().byId("difAmount").setIndicator("None");c=e*100/n;if(c>50||c<-50)this.getView().byId("difAmount").setValueColor("Error");else if(c>0||c<0)this.getView().byId("difAmount").setValueColor("Critical");else this.getView().byId("difAmount").setValueColor("Good")},onNavBack:function(){var e=Math.max.apply(Math,this.getView().byId("treeTable").getSelectedIndices());var t=this.getModel("objectView");this.getView().byId("treeTable").removeSelectionInterval(0,e);t.setProperty("/PO",false);this.getOwnerComponent().getRouter().navTo("worklist",{})},onShareInJamPress:function(){var e=this.getModel("objectView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},_onObjectMatched:function(e){var r=e.getParameter("arguments").objectId;this._bindView("/Invoice"+r);var i=this.byId("treeTable");var a=this._loadPurchaseOrders();var o=new t(a);i.setModel(o);i.bindRows({path:"/value",sorter:{path:"PurchaseOrderItem",descending:true},filters:[{path:"Status",operator:"EQ",value1:"Pending"}],parameters:{expand:"To_PurchaseOrderItems",navigation:{value:"To_PurchaseOrderItems"}}})},_bindView:function(e){var t=this.getModel("objectView");var r=this;this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=this.getModel("objectView"),r=e.getElementBinding();if(!r.getBoundContext()){this.getRouter().getTargets().display("objectNotFound");return}var i=this.getResourceBundle();var a=this;e.getBindingContext().requestObject().then(function(e){var r=e.DocNumber,o=e.SupplierName;n=parseFloat(e.NetPriceAmount);a.updateNumber(n);this.addHistoryEntry({title:this.getResourceBundle().getText("objectTitle")+" - "+o,icon:"sap-icon://enter-more",intent:"#InvoiceSubmission-display&/Invoice("+r+")"});t.setProperty("/busy",false);t.setProperty("/saveAsTileTitle",i.getText("saveAsTileTitle",[o]));t.setProperty("/shareOnJamTitle",o);t.setProperty("/shareSendEmailSubject",i.getText("shareSendEmailObjectSubject",[r]));t.setProperty("/shareSendEmailMessage",i.getText("shareSendEmailObjectMessage",[o,r,location.href]))}.bind(this))}})});